<!DOCTYPE html>
<html>

<head>
  <title>Egypt Crime Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/leaflet.css" />
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" type="text/css">
  <style>
    body {
      padding: 0;
      margin: 0;
    }
    html,
    body,
    #map {
      height: 100%;
    }
    .info {
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: white;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }
    .info h4 {
      margin: 0 0 5px;
      color: #777;
    }
    .legend,
    .categories {
      text-align: left;
      line-height: 18px;
      color: #555;
    }
    .legend i,
    .categories i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
    #leaflet-slider {
      width: 600px !important;
      margin: 20px;
    }
  </style>
</head>

<body>
  <div id="map" style="width:100%"></div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.2/jquery.ui.touch-punch.min.js"></script>

  <script src="js/leaflet-src.js"></script>
  <script src="js/leaflet-pip.js"></script>
  <script src="js/jsGradient.js"></script>
  <!-- script src="js/leaflet.SliderControl.min.js"></script -->

  <script src="js/utils.js"></script>
  <script src="js/states.js"></script>
  <script src="js/categories.js"></script>
  <script src="js/incidents.js"></script>




  <script>
    var map = L.map('map', {
      zoomControl: false
    }).setView([28.285033294640684, 30.30029296875], 7);


    L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
      subdomains: 'abcd',
      minZoom: 0,
      maxZoom: 18
    }).addTo(map);



    cairo = $.ajax({
      url: "geojson/cairo.geojson",
      dataType: "json",
      async: false
    }).responseJSON;
    console.log('geojson/cairo.geojson loaded');

    egypt = $.ajax({
      url: "geojson/egypt-mploygon.geojson",
      dataType: "json",
      async: false
    }).responseJSON;
    console.log('geojson/egypt-mploygon.geojson loaded');




    // get color depending on population density value
    //var colors = jsgradient.generateGradient('#07E3F2', '#155994', 8);
    var colors = jsgradient.generateGradient('#eeeeee', '#000000', 9);
    //console.log(colors);

    function getColor(d) {
      //console.log(d);
      return d > 20 ? colors[8] :
        d > 10 ? colors[7] :
        d > 5 ? colors[6] :
        d > 1 ? colors[5] :
        d > 0.5 ? colors[4] :
        d > 0.2 ? colors[3] :
        d > 0.1 ? colors[2] :
        d > 0 ? colors[1] :
        colors[0];
    }

    function fillColor(feature) {
      if (feature.properties.incidents) {
        return getColor((feature.properties.incidents.length * 100 / incidents.total).toFixed(2));
      }

      return getColor(0);
    }

    function style(feature) {
      // if(feature.properties.incidents){
      //   console.log(1-(feature.properties.incidents.length *10/incidents.length).toFixed(2));
      // }
      //console.log(feature.properties.incidents.length *100/incidents.length)
      return {
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7,
        fillColor: fillColor(feature)
      }
    }

    //cairoLayer = L.geoJson(cairo);
    egyptLayer = L.geoJson(egypt, {
      style: style
    });

    jQuery.each(incidents.all(), function(key, incident) {

      var latLng = new L.latLng(incident.lat, incident.lng);

      var results = leafletPip.pointInLayer(latLng, egyptLayer, true);
      jQuery.each(results, function(key, layer) {
        if (layer.feature.properties.incidents) {
          layer.feature.properties.incidents.push(incident);
        } else {
          layer.feature.properties.incidents = [];
          layer.feature.properties.incidents.push(incident);
        }

      });
      //if(key > 100) return false; //limit
    });




    jQuery.each(egyptLayer.getLayers(), function(k, layer) {
      feature = layer.feature;
      count = 0;

      if (feature.properties.incidents) {
        count = feature.properties.incidents.length;
      }
      var state = states.findByName(feature.properties.name);
      var contents = ['<b>', feature.properties.name, '</b><br />',
        'Incidents: ' , count, ' (%' , (count * 100 / incidents.total).toFixed(2)  , '%)', '<br />',
        'Population: ' , state.population.format(), ' (' , (state.population * 100 / states.totalPopulation).toFixed(2)  , '%)','<br />',
        'Area: ' , state.area.format(), ' km<sup>2</sup>',' (' , (state.area * 100 / states.totalArea).toFixed(2)  , '%)', '<br />'
      ].join('');
      //feature.properties.name + " " + count * 100 / incidents.total
      layer.bindPopup(contents);
      egyptLayer.resetStyle(layer);

    });

    egyptLayer.addTo(map);

    /**** CONTROLS ****/



    /* categories */

    var categoryControl = L.control({position: 'topright'});
    categoryControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info categories');
      list = [];
      jQuery.each(categories.all(), function(index, item){
        //use parent categories only
        list.push(
          '<i id="cat' + item.id +'" style="background:#' + item.color + '"></i> ' +
          item.name + ' (' + item.allIncidents().length + ')'
        );
      });
      div.innerHTML = "<b>Categories</b><hr/>";
      div.innerHTML += list.join('<br>');
      //console.log(div);
      return div;
    } //end onAdd

    categoryControl.addTo(map);

    /* Title */

    var titleControl = L.control({
      position: 'topleft'
    });
    titleControl.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'info title')
        div.innerHTML = '<h1>Choropleth Map of Crimes in Egypt</h1>';
        div.innerHTML += '<p>Based on <a href="http://zabatak.com">Zabatk.com</a> crowdsourced information of total <b>' + incidents.length + '</b> incidents</p>';
        return div;
      } //end onAdd

    titleControl.addTo(map);

    L.control.zoom({
      position: 'topleft'
    }).addTo(map);




    /**
     Legend
    */
    var legend = L.control({
      position: 'bottomright'
    });
    legend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 0.1, 0.2, 0.5, 1, 5, 10, 20],
        labels = [],
        from, to;

      for (var i = 0; i < grades.length; i++) {
        from = grades[i];
        to = grades[i + 1];

        labels.push(
          '<i style="background:' + getColor(from) + '"></i> ' +
          from + (to ? '&ndash;' + to : '+'));
      }

      div.innerHTML = "<b>Legend</b><hr/>";
      div.innerHTML += labels.join('<br>');
      return div;
    };

    legend.addTo(map);

    // var sliderControl = L.control.sliderControl({
    //   position: "bottomleft",
    //   layer: egyptLayer,
    //   range: true
    // });
    //
    // //Make sure to add the slider to the map ;-)
    // map.addControl(sliderControl);
    // //An initialize the slider
    // sliderControl.startSlider();


    egyptLayer.on('click', function(e) {
      //console.log(e);
    });
  </script>
</body>

</html>
